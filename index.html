<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RetSOL Browser Emulator</title>
    <style>
        body { 
            background-color: #050505; 
            background-image: linear-gradient(to bottom, #050505, #1a0033);
            color: #00ffa3; 
            font-family: 'Courier New', Courier, monospace; 
            text-align: center; 
            margin: 0; 
            padding: 0;
            overflow-x: hidden; 
        }

        /* Screen Container */
        #screen-container {
            position: relative;
            display: inline-block;
            width: 100vw;
            max-height: 60vh;
            background: black;
            overflow: hidden;
            box-shadow: 0px 0px 20px #ff00ff;
        }

        canvas { 
            width: 100%; 
            height: auto; 
            image-rendering: pixelated; 
            display: block;
        }

        /* CRT Scanline Overlay */
        #crt-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 4px, 3px 100%;
            pointer-events: none; /* Let clicks pass through */
            display: none; /* Off by default */
            z-index: 10;
        }

        .menu { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            padding: 15px; 
        }

        button { 
            padding: 18px; 
            border: 2px solid;
            border-radius: 4px; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 13px;
            text-transform: uppercase;
            background: transparent;
            transition: 0.2s;
        }

        .btn-link { color: #00ffa3; border-color: #00ffa3; grid-column: span 2; box-shadow: 0 0 10px #00ffa3; }
        .btn-load { color: #00e0ff; border-color: #00e0ff; grid-column: span 2; box-shadow: 0 0 10px #00e0ff; }
        .btn-save { color: #ff3e81; border-color: #ff3e81; box-shadow: 0 0 10px #ff3e81; }
        .btn-crt  { color: #ffff00; border-color: #ffff00; box-shadow: 0 0 10px #ffff00; }
        .btn-state { color: #bc00ff; border-color: #bc00ff; box-shadow: 0 0 10px #bc00ff; grid-column: span 2;}

        button:active { transform: scale(0.95); background: white; color: black; }

        #status { font-size: 11px; color: #ff00ff; margin-top: 5px; text-shadow: 0 0 5px #ff00ff; }
    </style>
</head>
<body>

    <div id="screen-container">
        <div id="crt-overlay"></div>
        <canvas id="screen" width="240" height="160"></canvas>
    </div>
    
    <div id="status">SYSTEM READY... LINK SD FOLDER</div>

    <div class="menu">
        <button class="btn-link" onclick="selectSavesFolder()">üìÅ LINK SD SAVES FOLDER</button>
        <button class="btn-load" onclick="loadRom()">üéÆ SELECT GBA GAME</button>
        <button class="btn-save" onclick="saveToSD()">üíæ MANUAL SAVE</button>
        <button class="btn-crt" onclick="toggleCRT()">üì∫ CRT SCANLINES</button>
        <button class="btn-state" onclick="loadRom()">üìÇ LOAD SAVED GAME (.SAV)</button>
    </div>

    <script src="https://unpkg.com/gbajs2@latest/dist/index.js"></script>

    <script>
        const gba = new GBA();
        const canvas = document.getElementById('screen');
        const status = document.getElementById('status');
        const crt = document.getElementById('crt-overlay');
        gba.setCanvas(canvas);

        let savesFolderHandle;

        function toggleCRT() {
            crt.style.display = (crt.style.display === 'none' || crt.style.display === '') ? 'block' : 'none';
        }

        async function selectSavesFolder() {
            try {
                savesFolderHandle = await window.showDirectoryPicker();
                status.innerText = "ACCESS GRANTED: SD FOLDER LINKED";
            } catch (e) {
                status.innerText = "ERROR: ACCESS DENIED";
            }
        }

        async function loadRom() {
            const [fileHandle] = await window.showOpenFilePicker();
            const file = await fileHandle.getFile();
            const reader = new FileReader();
            reader.onload = (e) => {
                // If it's a save file, load the state
                if (file.name.endsWith('.sav')) {
                    const state = JSON.parse(new TextDecoder().decode(e.target.result));
                    gba.defrost(state);
                    status.innerText = "STATE LOADED: " + file.name;
                } else {
                    // It's a game ROM
                    gba.loadRom(e.target.result, (success) => {
                        if (success) {
                            gba.run();
                            status.innerText = "RUNNING: " + file.name;
                        }
                    });
                }
            };
            if (file.name.endsWith('.sav')) {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        async function saveToSD() {
            if (!savesFolderHandle) return alert("Link SD folder first!");
            const fileName = `retsol-${Date.now()}.sav`;
            const fileHandle = await savesFolderHandle.getFileHandle(fileName, { create: true });
            const writable = await fileHandle.createWritable();
            const state = gba.freeze();
            await writable.write(JSON.stringify(state));
            await writable.close();
            status.innerText = "SAVED TO SD: " + fileName;
        }

        setInterval(() => { if (gba.isRunning && savesFolderHandle) saveToSD(); }, 1000 * 60 * 5);
        window.addEventListener('beforeunload', () => { if (gba.isRunning && savesFolderHandle) saveToSD(); });

        const BUTTON_MAP = { 0: gba.keypad.A, 1: gba.keypad.B, 9: gba.keypad.START, 8: gba.keypad.SELECT, 12: gba.keypad.UP, 13: gba.keypad.DOWN, 14: gba.keypad.LEFT, 15: gba.keypad.RIGHT, 4: gba.keypad.L, 5: gba.keypad.R };
        
        function updateGamepad() {
            const gp = navigator.getGamepads()[0];
            if (gp) {
                for (const [idx, key] of Object.entries(BUTTON_MAP)) {
                    if (gp.buttons[idx].pressed) gba.keypad.keydown(key);
                    else gba.keypad.keyup(key);
                }
            }
            requestAnimationFrame(updateGamepad);
        }
        window.addEventListener("gamepadconnected", () => {
            status.innerText = "CONTROLLER DETECTED";
            updateGamepad();
        });
    </script>
</body>
</html>
