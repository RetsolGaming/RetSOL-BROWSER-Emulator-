<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RetSOL-BROWSER-GBAEmulator</title>
    <style>
        body { 
            background-color: #050505; 
            background-image: linear-gradient(to bottom, #050505, #1a0033);
            color: #00ffa3; 
            font-family: 'Courier New', Courier, monospace; 
            text-align: center; 
            margin: 0; 
            padding: 0;
            overflow-x: hidden; 
        }

        /* Screen Container */
        #screen-container {
            position: relative;
            display: inline-block;
            width: 100vw;
            max-height: 60vh;
            background: black;
            overflow: hidden;
            box-shadow: 0px 0px 30px #ff00ff;
            border-bottom: 2px solid #ff00ff;
        }

        canvas { 
            width: 100%; 
            height: auto; 
            image-rendering: pixelated; 
            display: block;
        }

        /* CRT Scanline Overlay */
        #crt-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 4px, 3px 100%;
            pointer-events: none; 
            display: none; 
            z-index: 10;
        }

        .menu { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            padding: 20px; 
        }

        /* Cyberpunk Buttons */
        button { 
            padding: 18px; 
            border: 2px solid;
            border-radius: 0px; /* Square edges look more retro */
            font-weight: bold; 
            cursor: pointer; 
            font-size: 12px;
            text-transform: uppercase;
            background: rgba(0, 0, 0, 0.6);
            transition: 0.1s;
        }

        .btn-link { color: #00ffa3; border-color: #00ffa3; grid-column: span 2; box-shadow: 0 0 15px #00ffa3; }
        .btn-load { color: #00e0ff; border-color: #00e0ff; grid-column: span 2; box-shadow: 0 0 15px #00e0ff; }
        .btn-save { color: #ff3e81; border-color: #ff3e81; box-shadow: 0 0 15px #ff3e81; }
        .btn-crt  { color: #ffff00; border-color: #ffff00; box-shadow: 0 0 15px #ffff00; }
        .btn-state { color: #bc00ff; border-color: #bc00ff; box-shadow: 0 0 15px #bc00ff; grid-column: span 2;}

        button:active { 
            transform: scale(0.98); 
            background: #fff; 
            color: #000; 
        }

        #status { 
            font-size: 11px; 
            color: #ff00ff; 
            margin-top: 10px; 
            text-shadow: 0 0 8px #ff00ff;
            letter-spacing: 2px;
        }
    </style>
</head>
<body>

    <div id="screen-container">
        <div id="crt-overlay"></div>
        <canvas id="screen" width="240" height="160"></canvas>
    </div>
    
    <div id="status">RETSOL GBA READY... LINK SD FOLDER</div>

    <div class="menu">
        <button class="btn-link" onclick="vibrate(); selectSavesFolder()">üìÅ LINK SD SAVES FOLDER</button>
        <button class="btn-load" onclick="vibrate(); loadRom()">üéÆ SELECT GBA GAME</button>
        <button class="btn-save" onclick="vibrate(); saveToSD()">üíæ MANUAL SAVE</button>
        <button class="btn-crt" onclick="vibrate(); toggleCRT()">üì∫ CRT SCANLINES</button>
        <button class="btn-state" onclick="vibrate(); loadRom()">üìÇ LOAD .SAV FILE</button>
    </div>

    <script src="https://unpkg.com/gbajs2@latest/dist/index.js"></script>

    <script>
        const gba = new GBA();
        const canvas = document.getElementById('screen');
        const status = document.getElementById('status');
        const crt = document.getElementById('crt-overlay');
        gba.setCanvas(canvas);

        let savesFolderHandle;

        // Makes the PSG1 buzz on tap
        function vibrate() {
            if (navigator.vibrate) navigator.vibrate(40);
        }

        function toggleCRT() {
            crt.style.display = (crt.style.display === 'none' || crt.style.display === '') ? 'block' : 'none';
        }

        async function selectSavesFolder() {
            try {
                savesFolderHandle = await window.showDirectoryPicker();
                status.innerText = "ACCESS GRANTED: SD LINKED";
            } catch (e) {
                status.innerText = "ERROR: ACCESS DENIED";
            }
        }

        async function loadRom() {
            try {
                const [fileHandle] = await window.showOpenFilePicker();
                const file = await fileHandle.getFile();
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (file.name.endsWith('.sav')) {
                        const state = JSON.parse(new TextDecoder().decode(e.target.result));
                        gba.defrost(state);
                        status.innerText = "STATE RESTORED: " + file.name;
                    } else {
                        gba.loadRom(e.target.result, (success) => {
                            if (success) { gba.run(); status.innerText = "RUNNING: " + file.name; }
                        });
                    }
                };
                reader.readAsArrayBuffer(file);
            } catch (e) {
                status.innerText = "LOAD CANCELLED";
            }
        }

        async function saveToSD() {
            if (!savesFolderHandle) return alert("Link SD folder first!");
            try {
                const fileName = `retsol-${Date.now()}.sav`;
                const fileHandle = await savesFolderHandle.getFileHandle(fileName, { create: true });
                const writable = await fileHandle.createWritable();
                const state = gba.freeze();
                await writable.write(JSON.stringify(state));
                await writable.close();
                status.innerText = "SAVED: " + fileName;
            } catch (e) {
                status.innerText = "SAVE FAILED";
            }
        }

        setInterval(() => { if (gba.isRunning && savesFolderHandle) saveToSD(); }, 1000 * 60 * 5);
        window.addEventListener('beforeunload', () => { if (gba.isRunning && savesFolderHandle) saveToSD(); });

        const BUTTON_MAP = { 0: gba.keypad.A, 1: gba.keypad.B, 9: gba.keypad.START, 8: gba.keypad.SELECT, 12: gba.keypad.UP, 13: gba.keypad.DOWN, 14: gba.keypad.LEFT, 15: gba.keypad.RIGHT, 4: gba.keypad.L, 5: gba.keypad.R };
        
        function updateGamepad() {
            const gp = navigator.getGamepads()[0];
            if (gp) {
                for (const [idx, key] of Object.entries(BUTTON_MAP)) {
                    if (gp.buttons[idx].pressed) gba.keypad.keydown(key);
                    else gba.keypad.keyup(key);
                }
            }
            requestAnimationFrame(updateGamepad);
        }
        window.addEventListener("gamepadconnected", () => {
            status.innerText = "CONTROLLER ACTIVE";
            updateGamepad();
        });
    </script>
</body>
</html>
